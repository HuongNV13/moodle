define ("qtype_ddmarker/question",["jquery","core/dragdrop","qtype_ddmarker/shapes","core/key_codes"],function(a,b,c){"use strict";function d(a,b,c){this.containerId=a;this.visibleDropZones=c;if(b){this.getRoot().addClass("qtype_ddmarker-readonly")}this.cloneDrags();this.repositionDrags();this.drawDropzones()}d.prototype.cloneDrags=function(){var b=this;b.getRoot().find("div.draghomes span.marker").each(function(c,d){var e=a(d),f=e.clone();f.removeClass();f.addClass("marker choice"+b.getChoice(e)+" dragno"+b.getDragNo(e)+" dragplaceholder");e.before(f)})};d.prototype.getChoice=function(a){return this.getClassnameNumericSuffix(a,"choice")};d.prototype.getDragNo=function(a){return this.getClassnameNumericSuffix(a,"dragno")};d.prototype.handleDragStart=function(c){var d=this,e=a(c.target).closest(".marker"),f=b.prepare(c);if(!f.start){return}e.addClass("beingdragged");var g=!e.hasClass("unneeded");if(!g){var h=d.getDragClone(e);if(h.length){h.addClass("active");e.offset(h.offset())}}b.start(c,e,function(){},function(a,b,c){d.dragEnd(c)})};d.prototype.dragEnd=function(a){var b=!1,d=this.getChoiceNoFromElement(a);a.data("pagex",a.offset().left).data("pagey",a.offset().top);if(this.coordsInBgImg(new c.Point(a.data("pagex"),a.data("pagey")))){this.sendDragToDrop(a);b=!0}if(!b){this.sendDragHome(a);this.removeDragIfNeeded(a)}else{this.cloneDragIfNeeded(a)}this.saveCoordsForChoice(d,a)};d.prototype.saveCoordsForChoice=function(b){var d=[],e=this.getRoot().find("span.marker.choice"+b),f=this;if(e.length){e.each(function(){var b=a(this);if(!b.hasClass("beingdragged")){var e=new c.Point(b.data("pagex"),b.data("pagey"));if(f.coordsInBgImg(e)){d[d.length]=f.convertToBgImgXY(e)}}})}this.getRoot().find("input.choice"+b).val(d.join(";"))};d.prototype.getChoiceNoFromElement=function(a){return+this.getClassnameNumericSuffix(a,"choice")};d.prototype.getClassnameNumericSuffix=function(b,c){var d=a(b).attr("class");if(d!==void 0&&""!==d){for(var e=d.split(" "),f=0,g;f<e.length;f++){g=new RegExp("^"+c+"([0-9])+$");if(g.test(e[f])){var h=/([0-9])+$/,i=h.exec(e[f]);return+i[0]}}}return null};d.prototype.getRoot=function(){return a(document.getElementById(this.containerId))};d.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")};d.prototype.convertToBgImgXY=function(a){var b=this.bgImage();return a.offset(-b.offset().left-1,-b.offset().top-1)};d.prototype.coordsInBgImg=function(a){var b=this.bgImage(),c=b.offset();return a.x>=c.left&&a.x<c.left+b.width()&&a.y>=c.top&&a.y<c.top+b.height()};d.prototype.repositionDrags=function(){var b=this.getRoot(),c=this;b.find("div.draghomes .marker").not(".dragplaceholder").each(function(b,c){a(c).addClass("unneeded")});b.find("input.choices").each(function(a,b){var d=c.getChoiceNoFromElement(b),e=c.getCoords(b);if(e.length){var f=c.getRoot().find(".draghomes span.marker.choice"+d).not(".dragplaceholder");f.remove();for(var g=0,h;g<e.length;g++){h=f.clone();h.data("pagex",e[g].x).data("pagey",e[g].y);c.sendDragToDrop(h)}c.getDragClone(f).addClass("active");c.cloneDragIfNeeded(f)}})};d.prototype.getDragClone=function(a){return this.getRoot().find(".draghomes span.marker.choice"+this.getChoice(a)+".dragno"+this.getDragNo(a)+".dragplaceholder")};d.prototype.dropArea=function(){return this.getRoot().find("div.droparea")};d.prototype.sendDragHome=function(a){a.removeClass("beingdragged").addClass("unneeded").css("top","").css("left","");var b=this.getDragClone(a);b.after(a);b.removeClass("active")};d.prototype.sendDragToDrop=function(a){var b=this.dropArea();a.removeClass("beingdragged").removeClass("unneeded");var d=this.convertToBgImgXY(new c.Point(a.data("pagex"),a.data("pagey")));a.css("left",d.x).css("top",d.y);b.append(a)};d.prototype.cloneDragIfNeeded=function(a){var b=this.getInput(a),c=+this.getClassnameNumericSuffix(b,"noofdrags"),d=this.getRoot().find("div.droparea .marker.choice"+this.getChoice(a)+".dragno"+this.getDragNo(a)).length,e=this.getRoot().find("div.draghomes .marker.choice"+this.getChoice(a)+".dragno"+this.getDragNo(a)).not(".dragplaceholder").length;if(d<c&&0===e){var f=a.clone();f.addClass("unneeded").css("top","").css("left","");this.getDragClone(a).removeClass("active").after(f)}};d.prototype.removeDragIfNeeded=function(a){var b=this.getRoot().find("div.draghomes .marker.choice"+this.getChoice(a)+".dragno"+this.getDragNo(a)).not(".dragplaceholder").length;if(1<b){this.getRoot().find("div.draghomes .marker.choice"+this.getChoice(a)+".dragno"+this.getDragNo(a)).not(".dragplaceholder").first().remove()}};d.prototype.getInput=function(a){var b=this.getChoiceNoFromElement(a);return this.getRoot().find("input.choices.choice"+b)};d.prototype.drawDropzones=function(){if(0<this.visibleDropZones.length){var a=this.bgImage();this.getRoot().find("div.dropzones").html("<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"dropzones\" width=\""+a.outerWidth()+"\" height=\""+a.outerHeight()+"\"></svg>");for(var b=this.getRoot().find("svg.dropzones"),c=0,d=0,e;d<this.visibleDropZones.length;d++){e="color"+c;c=(c+1)%8;this.addDropzone(b,d,e)}}};d.prototype.addDropzone=function(a,b,d){var e=this.visibleDropZones[b],f=c.make(e.shape,""),g;if(!f.parse(e.coords)){return}g=this.getRoot().find("div.markertexts span.markertext"+b);if(g.length){if(""!==e.markertext){g.html(e.markertext)}else{g.remove()}}else if(""!==e.markertext){this.getRoot().find("div.markertexts").append("<span class=\""+("markertext markertext"+b)+"\">"+e.markertext+"</span>");var h=this.getRoot().find("div.ddarea div.markertexts span.markertext"+b);if(h.length){var i=f.getHandlePositions(),j=this.convertToWindowXY(i.moveHandle.offset(-h.outerWidth()/2,-h.outerHeight()/2));h.offset({left:j.x-4,top:j.y})}}var k=f.makeSvg(a[0]);k.setAttribute("class","dropzone "+d)};d.prototype.convertToWindowXY=function(a){var b=this.bgImage();return a.offset(b.offset().left+1,b.offset().top+1)};d.prototype.getCoords=function(b){var d=[],e=a(b).val();if(""!==e){for(var f=e.split(";"),g=0;g<f.length;g++){d[g]=this.convertToWindowXY(c.Point.parse(f[g]))}}return d};var f={eventHandlersInitialised:!1,questions:{},init:function init(a,b,c){f.questions[a]=new d(a,b,c);if(!f.eventHandlersInitialised){f.setupEventHandlers();f.eventHandlersInitialised=!0}console.log("Done")},setupEventHandlers:function setupEventHandlers(){a("body").on("mousedown touchstart",".que.ddmarker:not(.qtype_ddmarker-readonly) div.draghomes .marker",f.handleDragStart).on("mousedown touchstart",".que.ddmarker:not(.qtype_ddmarker-readonly) div.droparea .marker",f.handleDragStart)},handleDragStart:function handleDragStart(a){a.preventDefault();var b=f.getQuestionForEvent(a);if(b){b.handleDragStart(a)}},getQuestionForEvent:function getQuestionForEvent(b){var c=a(b.currentTarget).closest(".que.ddmarker").attr("id");return f.questions[c]}};return{init:f.init}});
//# sourceMappingURL=question.min.js.map
